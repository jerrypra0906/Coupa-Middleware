TECHNICAL DESIGN DOCUMENT (TDD)Module: Exchange Rate Integration – SAP S/4HANA ↔ Middleware ↔ Coupa1. PurposeThis document describes the technical design for integrating SAP Exchange Rates with Coupa through the Custom Middleware.The module pulls exchange rates from SAP, formats them, stores them in the middleware staging DB, generates CSV/API payload, and sends it to Coupa based on admin-configured schedule.The module also supports:Manual execution via middleware UIAutomated scheduling (configurable in UI)Error logging & notificationEmail alerts to configured recipientsDashboard monitoring2. High-Level End-to-End FlowMiddleware scheduler triggers job (interval defined by admin).Middleware calls SAP OData/API/Z-program to pull exchange rate data.Middleware processes data:Apply SAP business rules (including “/” prefix conversion)Map fields to Coupa structureGenerate CSV or JSON (based on integration type)Middleware sends file via:SFTP folder (Incoming/ExchangeRates)Or Coupa API endpointCoupa processes file and returns response.Middleware logs success or error per line item.If error:Error stored in DBEmail notification sent to configured recipientsAdmin can drill down to detailed error in UIAdmin can re-run integration manually3. Technical Architecture (Module Scope Only)LandscapeSAP S/4HANA – Source of Exchange RatesMiddleware (Custom Web Platform)Web Admin UIScheduler ServiceIntegration EngineLog EngineNotification ServicePostgreSQL DatabaseCoupa – Target systemTransport Method SupportedCSV over SFTPJSON via REST API4. Data Source & SAP Specification (Reference from FSD)4.1 SAP Table ReferenceTableDescriptionKey FieldsTCURRExchange RatesFCURR, TCURR, GDATU, UKURSTVARVCSelection variablesNAME, LOW, HIGHCustom SAP Z-programProvides filtered rate outputZFI_EXCRAT_SC5. Middleware Functional Logic5.1 Data Extraction Logic (from SAP)Middleware calls SAP using:Option A: SAP OData Service/sap/opu/odata/SAP/Z_EXCHRATES_SRV/ExchangeRateSetOption B: SAP RFC via API GatewayOption C: Z-program execution via APITrigger: ZFI_EXCRAT_SC5.2 Business Logic Replicated in MiddlewareGet currency conversion listQuery equivalent of TVARVC listList of (From Currency → To Currency) pairsPull Exchange Rate DataRead FCURR, TCURR, GDATU, UKURSSpecial Rule: “/” Prefix ConversionIf rate = /15000→ System converts to:1 / 15000 = 0.00006667 (8 decimal places)Data Mapping (detailed below)Write to PostgreSQL staging DBGenerate File (CSV or JSON)Send to Coupa6. Field Mapping (SAP → Middleware → Coupa)Coupa ColumnDescriptionSAP FieldMiddleware FieldFrom CurrencyBase currencyTCURR-FCURRfrom_currencyTo CurrencyTarget currencyTCURR-TCURRto_currencyRateConverted or raw rateTCURR-UKURSrate_valueRate DateValid FromTCURR-GDATUrate_date7. PostgreSQL Database Design7.1 Table: EXCHANGE_RATE_STAGINGField NameTypeDescriptionidPKAuto IDfrom_currencyVARCHAR(3)SAP FCURRto_currencyVARCHAR(3)SAP TCURRrate_valueNUMBER(20,8)Converted UKURSrate_dateDATESAP GDATUstatusVARCHAR(20)NEW / PROCESSED / ERRORcreated_atTIMESTAMP—updated_atTIMESTAMP—7.2 Table: INTEGRATION_LOGCaptures each execution result.7.3 Table: INTEGRATION_ERROR_DETAILCaptures line-item error message.7.4 Table: NOTIFICATION_RECIPIENTSStores email recipients configurable from UI.8. Admin Web UI Requirements8.1 Scheduler Configuration PageAdmin can configure:Execution interval (minutes/hours/daily)Integration mode (CSV / API)Active/Inactive toggleSAP endpoint configurationCoupa SFTP/API credentialsRetry mode: Automatic / Manual8.2 Log Monitoring PageDisplays:Execution timestampTotal recordsSuccess countError countDurationStatus (Success / Partial / Failed)With drill-down for each line item.8.3 Error Details PageShows:From CurrencyTo CurrencyRateRate DateCoupa return messageIntegration step failedRetry button8.4 Email Notification SetupAdmin can:Add/Delete email recipientsEnable/Disable notificationsTest-email button9. Integration File Format Specification9.1 CSV Format (per Coupa Standard)Filename:ExchangeRate_YYYYMMDD_HHMMSS.csvDelimiter: commaColumnFrom CurrencyTo CurrencyRateRate DateExample:"IDR","USD","0.00006667","20250115""USD","EUR","0.91000000","20250115"10. Integration Error HandlingErrors are categorized:10.1 Technical ErrorsNetwork failureSFTP authentication failedAPI timeoutSAP connection failure10.2 Functional ErrorsInvalid date formatMissing currency mappingInvalid rate (null or zero)Coupa rejected record10.3 Error Handling FlowError stored in databaseUI shows line-item errorsEmail sent to recipientsAdmin can retry manuallyLog is updated11. Dashboard RequirementsDashboard will show:WidgetsIntegration Success Rate (%)Error Trend per DayTop 5 Most Failed Currency PairsLast 10 Execution SummaryUpcoming Scheduled Jobs12. Test Scenarios (High-Level)Test CaseDescriptionExpected ResultTC01Scheduler triggers jobData pulled & processedTC02Manual runAdmin can executeTC03“/” prefix conversionCorrect 8-decimal outputTC04CSV generationValid format per CoupaTC05API call successStatus = SUCCESSTC06API call failureError logged + email sentTC07UI shows logsAccurate resultTC08View line-item errorDetails shownTC09Retry processingOnly error rows processedTC10Change scheduler frequencyScheduler updates13. Security RequirementsOAuth2 or API Key for Coupa APIBasic Auth or OAuth for SAP APIRole-based access for Admin UIEncryption at rest (PostgreSQL)Encryption in transit (HTTPS, SFTP SSH2)14. Non-Functional RequirementsAvailability: 99%Max processing time for 1 job: < 3 minutesMax daily volume: 10,000 exchange rate rowsLog retention: 12 months
